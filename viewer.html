<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ad Viewer</title>

  <!-- Content Security Policy -->
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self' https://*.firebaseio.com https://firestore.googleapis.com;
    script-src 'self' 'unsafe-inline' https://www.gstatic.com https://www.googleapis.com;
    style-src 'self' 'unsafe-inline';
    img-src * data:;
    frame-src *;
  ">

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background: #fffbe6;
    }

    #header, #nav, #footer {
      width: 100%;
    }

    .scrolling-bar {
      background: darkred;
      color: yellow;
      padding: 4px;
      font-weight: bold;
      font-size: 14px;
      overflow: hidden;
      white-space: nowrap;
    }

    .scrolling-bar marquee {
      width: 100%;
    }

    .invite-bar {
      background: darkblue;
      color: white;
      padding: 4px;
      text-align: center;
    }

    .invite-bar a {
      color: white;
      font-weight: bold;
      text-decoration: none;
    }

    .ad-row {
      display: flex;
      justify-content: space-between;
      background: wheat;
      padding: 5px;
      max-height: 70px;
    }

    .ad-cell {
      width: 49%;
      text-align: center;
      vertical-align: middle;
    }

    iframe#adIframe {
      width: 100%;
      height: 1000px;
      border: none;
      display: block;
    }
  </style>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBBn8RmuXVvkbbBB0IquYr9S6hXhIgrQCQ",
      authDomain: "lla5785.firebaseapp.com",
      projectId: "lla5785",
      appId: "1:730972554331:web:d97a5fbacebd6aa6e32b7e"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
  </script>
</head>
<body onload="fetchAdsAndDisplay()">

  <div id="header">
    <script>
      fetch("header.html").then(r => r.text()).then(html => {
        document.getElementById("header").innerHTML = html;
      }).catch(() => {
        document.getElementById("header").innerHTML = "<h3>LOADING HEADER...</h3>";
      });
    </script>
  </div>

  <!-- Scrolling banner -->
  <div class="scrolling-bar">
    <marquee>SCROLL TO VIEW ALL ADS</marquee>
  </div>

  <!-- Invite link bar -->
  <div class="invite-bar">
    <a href="https://saphahcentral.github.io/lla5785v3-0/account1.html" target="_blank">
      ðŸ‘‰ ADD YOUR WEBSITE HERE FOR MAXIMUM LIFETIME EXPOSURE!
    </a>
  </div>

  <!-- Ads display -->
  <div class="ad-row">
    <div class="ad-cell" id="bannerAd">Loading banner ad...</div>
    <div class="ad-cell" id="textAd">Loading text ad...</div>
  </div>

  <!-- Main iframe -->
  <iframe id="adIframe" src="about:blank"></iframe>

  <!-- Bottom navigation -->
  <div id="nav">
    <script>
      fetch("nav_external.html").then(r => r.text()).then(html => {
        document.getElementById("nav").innerHTML = html;
      }).catch(() => {
        document.getElementById("nav").innerHTML = "<p>NAVIGATION FAILED TO LOAD</p>";
      });
    </script>
  </div>

  <!-- Footer -->
  <div id="footer">
    <script>
      fetch("footer.html").then(r => r.text()).then(html => {
        document.getElementById("footer").innerHTML = html;
      }).catch(() => {
        document.getElementById("footer").innerHTML = "<p>FOOTER FAILED TO LOAD</p>";
      });
    </script>
  </div>

  <!-- Fallback Ad logic -->
  <script>
    function useFallback(type) {
      if (type === "banner") {
        document.getElementById("bannerAd").innerHTML = `
          <a href="https://example.com/fallback1" target="_blank">
            <img src="https://via.placeholder.com/468x60?text=Fallback+Banner" alt="Fallback Banner" style="max-height:60px;">
          </a>`;
      } else if (type === "text") {
        document.getElementById("textAd").innerHTML = `
          <a href="https://example.com/fallback2" target="_blank" style="color: blue; text-decoration: underline;">
            Fallback Text Ad - Click Here!
          </a>`;
      } else if (type === "iframe") {
        document.getElementById("adIframe").src = "https://example.com/fallback-iframe";
      }
    }

    function useFallbackAds() {
      useFallback("banner");
      useFallback("text");
      useFallback("iframe");
    }
  </script>

  <!-- Random ad loader -->
  <script>
    async function fetchAdsAndDisplay() {
      try {
        const snapshot = await db.collection("ad_list").get();
        const ads = snapshot.docs.map(doc => doc.data());

        if (!ads || ads.length === 0) {
          useFallbackAds();
          return;
        }

        // Shuffle array once
        const shuffled = ads.sort(() => 0.5 - Math.random());

        const bannerAd = shuffled.find(ad => ad.banner && ad.url);
        const textAd = shuffled.find(ad => ad.text && ad.url && ad !== bannerAd);
        const iframeAd = shuffled.find(ad => ad.url && !ad.text && !ad.banner && ad !== bannerAd && ad !== textAd);

        if (bannerAd) {
          document.getElementById("bannerAd").innerHTML = `
            <a href="${bannerAd.url}" target="_blank">
              <img src="${bannerAd.banner}" alt="Banner Ad" style="max-height:60px;">
            </a>`;
        } else {
          useFallback("banner");
        }

        if (textAd) {
          document.getElementById("textAd").innerHTML = `
            <a href="${textAd.url}" target="_blank" style="color: blue; text-decoration: underline;">
              ${textAd.text}
            </a>`;
        } else {
          useFallback("text");
        }

        if (iframeAd) {
          document.getElementById("adIframe").src = iframeAd.url;
        } else {
          useFallback("iframe");
        }

      } catch (error) {
        console.error("Ad fetch error:", error);
        useFallbackAds();
      }
    }
  </script>
</body>
</html>
