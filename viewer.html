<!-- KEEP YOUR EXISTING HEAD, STYLES, HEADER/NAV LOADERS -->

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBBn8RmuXVvkbbBB0IquYr9S6hXhIgrQCQ",
    authDomain: "lla5785.firebaseapp.com",
    projectId: "lla5785",
    storageBucket: "lla5785.appspot.com",
    messagingSenderId: "730972554331",
    appId: "1:730972554331:web:d97a5fbacebd6aa6e32b7e"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  function shuffle(arr) {
    return arr.map(v => [v, Math.random()]).sort((a, b) => a[1] - b[1]).map(v => v[0]);
  }

  function useFallback(type) {
    if (type === "banner") {
      document.getElementById("bannerAd").innerHTML = `
        <a href="https://example.com/fallback1" target="_blank">
          <img src="https://via.placeholder.com/468x60?text=Fallback+Banner" alt="Fallback Banner" style="max-height:60px;">
        </a>`;
    } else if (type === "text") {
      document.getElementById("textAd").innerHTML = `
        <a href="https://example.com/fallback2" target="_blank" style="color: blue; text-decoration: underline;">
          Fallback Text Ad - Click Here!
        </a>`;
    } else if (type === "iframe") {
      document.getElementById("adIframe").src = "https://example.com/fallback-iframe";
    }
  }

  async function fetchAdsAndDisplay() {
    try {
      const snapshot = await db.collection("ad_list").get();
      const ads = snapshot.docs.map(doc => doc.data());

      if (!ads || ads.length === 0) {
        console.warn("No ads found. Using all fallbacks.");
        useFallback("banner");
        useFallback("text");
        useFallback("iframe");
        return;
      }

      const bannerAds = ads.filter(ad => ad.banner && ad.url);
      const textAds = ads.filter(ad => ad.text && ad.url);
      const iframeAds = ads.filter(ad => ad.url && (!ad.text && !ad.banner));

      // Log counts
      console.log("Total ads:", ads.length);
      console.log("Banner ads:", bannerAds.length);
      console.log("Text ads:", textAds.length);
      console.log("Iframe ads:", iframeAds.length);

      // --- Banner Ad ---
      if (bannerAds.length > 0) {
        const ad = shuffle(bannerAds)[0];
        document.getElementById("bannerAd").innerHTML = `
          <a href="${ad.url}" target="_blank">
            <img src="${ad.banner}" alt="Banner Ad" style="max-height:60px;">
          </a>`;
      } else {
        useFallback("banner");
      }

      // --- Text Ad ---
      if (textAds.length > 0) {
        const ad = shuffle(textAds)[0];
        document.getElementById("textAd").innerHTML = `
          <a href="${ad.url}" target="_blank" style="color: blue; text-decoration: underline;">
            ${ad.text}
          </a>`;
      } else {
        useFallback("text");
      }

      // --- Iframe Ad ---
      if (iframeAds.length > 0) {
        const ad = shuffle(iframeAds)[0];
        document.getElementById("adIframe").src = ad.url;
      } else {
        useFallback("iframe");
      }

    } catch (err) {
      console.error("Firestore fetch error:", err);
      useFallback("banner");
      useFallback("text");
      useFallback("iframe");
    }
  }

  function loadPartials() {
    fetch("header.html")
      .then(res => res.text())
      .then(html => document.getElementById("header-container").innerHTML = html);
    fetch("nav_external.html")
      .then(res => res.text())
      .then(html => document.getElementById("nav-container").innerHTML = html);
    fetch("footer.html")
      .then(res => res.text())
      .then(html => document.getElementById("footer-container").innerHTML = html);
  }

  window.addEventListener("load", () => {
    loadPartials();
    fetchAdsAndDisplay();
  });
</script>
