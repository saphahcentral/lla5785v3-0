<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Viewer Page</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0; padding: 0;
      background-color: #f9f9f9;
      text-align: center;
    }
    #nav-placeholder {
      margin-bottom: 1em;
    }
    #top-ads {
      margin-bottom: 1em;
    }
    #top-ads > div {
      margin: 10px 0;
    }
    #square-banner {
      display: inline-block;
      margin-bottom: 1em;
      width: 125px;
      height: 125px;
    }
    #square-banner img {
      width: 125px;
      height: 125px;
      border: 0;
    }
    iframe#ad-iframe {
      width: 100%;
      height: 500px;
      border: none;
      margin-top: 1em;
    }
    #text-ad {
      font-size: 1rem;
      margin: 1em 0;
      color: #333;
    }
  </style>
</head>
<body>

  <!-- Navigation -->
  <div id="nav-placeholder"></div>

  <!-- Inline text banner at top -->
  <div id="inline-banner">
    <strong>LIMITED OFFER: Promote Your Site Here!</strong>
  </div>

  <!-- Top Ads container -->
  <div id="top-ads">

    <!-- Banner ad -->
    <div id="banner-ad"></div>

    <!-- Text ad -->
    <div id="text-ad"></div>

    <!-- Square banner -->
    <a href="index.html" id="square-banner" title="Home">
      <img src="https://cdn-images.imagevenue.com/64/1b/fc/ME1AW7GR_o.png" alt="Square Banner" />
    </a>

  </div>

  <!-- Iframe ad -->
  <iframe id="ad-iframe" src=""></iframe>

<script>
  // Load navigation from nav_external.html (same folder)
  fetch('nav_external.html')
    .then(response => {
      if (!response.ok) throw new Error('Navigation not found');
      return response.text();
    })
    .then(html => {
      document.getElementById('nav-placeholder').innerHTML = html;
    })
    .catch(err => {
      console.error('Error loading nav:', err);
      document.getElementById('nav-placeholder').innerHTML = '';
    });

  // Firestore config and init (replace with your actual config)
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_AUTH_DOMAIN",
    projectId: "YOUR_PROJECT_ID",
    // other config options...
  };

  // Load Firebase SDK scripts dynamically (if not already included)
  function loadScript(url) {
    return new Promise((resolve, reject) => {
      let script = document.createElement('script');
      script.src = url;
      script.onload = () => resolve();
      script.onerror = () => reject(new Error('Failed to load script ' + url));
      document.head.appendChild(script);
    });
  }

  async function loadFirebase() {
    if (!window.firebase) {
      await loadScript('https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js');
      await loadScript('https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js');
    }
  }

  async function initAds() {
    await loadFirebase();

    // Initialize Firebase app
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.firestore();

    try {
      // Fetch all ads from 'ad_list' collection
      const snapshot = await db.collection('ad_list').get();

      const ads = [];
      snapshot.forEach(doc => {
        ads.push(doc.data());
      });

      // Filter ads by type
      const bannerAds = ads.filter(ad => ad.type === 'banner' && ad.status === 'active');
      const textAds = ads.filter(ad => ad.type === 'text' && ad.status === 'active');
      const iframeAds = ads.filter(ad => ad.type === 'iframe' && ad.status === 'active');

      // Helper: get random element from array or fallback null
      const getRandomAd = (arr) => arr.length ? arr[Math.floor(Math.random() * arr.length)] : null;

      // Pick random ads
      const bannerAd = getRandomAd(bannerAds);
      const textAd = getRandomAd(textAds);
      const iframeAd = getRandomAd(iframeAds);

      // Show banner ad
      if (bannerAd && bannerAd.html) {
        document.getElementById('banner-ad').innerHTML = bannerAd.html;
      } else {
        document.getElementById('banner-ad').innerHTML = '<div style="color:#888;">No banner ad available</div>';
      }

      // Show text ad
      if (textAd && textAd.html) {
        document.getElementById('text-ad').innerHTML = textAd.html;
      } else {
        document.getElementById('text-ad').innerHTML = '<div style="color:#888;">No text ad available</div>';
      }

      // Show iframe ad
      if (iframeAd && iframeAd.url) {
        document.getElementById('ad-iframe').src = iframeAd.url;
      } else {
        document.getElementById('ad-iframe').src = '';
      }

    } catch (error) {
      console.error('Error fetching ads:', error);
      document.getElementById('banner-ad').innerHTML = '<div style="color:red;">Error loading banner ad</div>';
      document.getElementById('text-ad').innerHTML = '<div style="color:red;">Error loading text ad</div>';
      document.getElementById('ad-iframe').src = '';
    }
  }

  // Run on page load
  window.onload = () => {
    initAds();
  };
</script>

</body>
</html>
