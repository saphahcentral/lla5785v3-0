<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Viewer with Ads and Nav</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 10px;
    }
    header, nav {
      border-bottom: 1px solid #ddd;
      padding: 10px;
      margin-bottom: 15px;
    }
    #square-banner img {
      width: 125px;
      height: 125px;
      cursor: pointer;
    }
    #banner-ad, #text-ad {
      margin: 10px auto;
      max-width: 728px;
      min-height: 60px;
      border: 1px solid #ccc;
      padding: 10px;
      color: #555;
    }
    #ad-iframe {
      width: 728px;
      height: 90px;
      border: 1px solid #ccc;
      margin: 15px auto;
      display: block;
    }
  </style>
</head>
<body>

  <!-- HEADER -->
  <header id="header">Loading header...</header>

  <!-- NAV -->
  <nav id="nav">Loading navigation...</nav>

  <!-- Square Banner -->
  <div id="square-banner" title="Go to Home" style="margin-bottom:15px;">
    <a href="index.html" target="_self">
      <img src="https://cdn-images.imagevenue.com/64/1b/fc/ME1AW7GR_o.png" alt="Square Banner" />
    </a>
  </div>

  <!-- Banner Ad -->
  <div id="banner-ad">Loading banner ad...</div>

  <!-- Text Ad -->
  <div id="text-ad">Loading text ad...</div>

  <!-- Iframe Ad -->
  <iframe id="ad-iframe" src="" title="Iframe Ad"></iframe>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    // Firebase config - REPLACE these with your actual config
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    // Initialize Firebase
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.firestore();

    // Load header & nav from files in same folder
    async function loadFragment(id, url) {
      try {
        const response = await fetch(url);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const text = await response.text();
        document.getElementById(id).innerHTML = text;
      } catch (e) {
        console.error(`Failed to load ${url}:`, e);
        document.getElementById(id).textContent = `Failed to load ${id}.`;
      }
    }

    loadFragment('header', 'header.html');
    loadFragment('nav', 'nav_external.html');

    // Helper for random pick
    function getRandomElement(arr) {
      return arr.length ? arr[Math.floor(Math.random() * arr.length)] : null;
    }

    // Load ads from Firestore
    async function loadAds() {
      try {
        const snapshot = await db.collection('ad_list').get();
        const ads = [];
        snapshot.forEach(doc => ads.push(doc.data()));

        console.log('Ads fetched:', ads);

        // Filter ads by type and active status
        const bannerAds = ads.filter(a => a.type === 'banner' && a.status === 'active' && a.html);
        const textAds = ads.filter(a => a.type === 'text' && a.status === 'active' && a.html);
        const iframeAds = ads.filter(a => a.type === 'iframe' && a.status === 'active' && a.url);

        console.log('Banner Ads:', bannerAds);
        console.log('Text Ads:', textAds);
        console.log('Iframe Ads:', iframeAds);

        // Pick one random ad from each
        const bannerAd = getRandomElement(bannerAds);
        const textAd = getRandomElement(textAds);
        const iframeAd = getRandomElement(iframeAds);

        // Show banner ad
        const bannerDiv = document.getElementById('banner-ad');
        if (bannerAd) {
          bannerDiv.innerHTML = bannerAd.html;
        } else {
          bannerDiv.textContent = 'No banner ad available.';
        }

        // Show text ad
        const textDiv = document.getElementById('text-ad');
        if (textAd) {
          textDiv.innerHTML = textAd.html;
        } else {
          textDiv.textContent = 'No text ad available.';
        }

        // Show iframe ad
        const iframe = document.getElementById('ad-iframe');
        if (iframeAd) {
          iframe.src = iframeAd.url;
          iframe.style.display = 'block';
        } else {
          iframe.src = '';
          iframe.style.display = 'none';
        }

      } catch (err) {
        console.error('Error loading ads:', err);
        document.getElementById('banner-ad').textContent = 'Error loading banner ad.';
        document.getElementById('text-ad').textContent = 'Error loading text ad.';
        const iframe = document.getElementById('ad-iframe');
        iframe.src = '';
        iframe.style.display = 'none';
      }
    }

    loadAds();
  </script>
</body>
</html>
